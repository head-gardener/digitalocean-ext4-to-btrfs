#! /usr/bin/env bash
# scp ext2btrfs root@12.345.678.912: && ssh root@12.345.678.912 bash ext2btrfs

set -e

RECOVERY="${RECOVERY:-}"
REBOOT="${REBOOT:-}"

#apt-get update
apt-get install -y btrfs-progs
apt-get install -y busybox-static

mount -t tmpfs ramdisk /mnt

mkdir /mnt/{old,proc,sys,dev,run}

mkdir -p /mnt/{bin,sbin,usr/bin,usr/sbin}

busybox="$(which busybox)"
cp "$busybox" /mnt/bin
/mnt/bin/busybox --install /mnt/bin

btrfsconvert="$(which btrfs-convert)"
cp "$btrfsconvert" /mnt/sbin
for f in $(ldd "$btrfsconvert" | perl -ne '/(\S+) \(0x[a-z0-9]+\)/ and print "$1\n"'); do
  [[ ! -f $f ]] && continue
  mkdir -p /mnt/${f%/*} && cp -v $f /mnt/$f
done

btrfs="$(which btrfs)"
cp "$btrfs" /mnt/sbin
for f in $(ldd "$btrfs" | perl -ne '/(\S+) \(0x[a-z0-9]+\)/ and print "$1\n"'); do
  [[ ! -f $f ]] && continue
  mkdir -p /mnt/${f%/*} && cp -v $f /mnt/$f
done

strace="$(which strace)"
cp "$strace" /mnt/sbin
for f in $(ldd "$strace" | perl -ne '/(\S+) \(0x[a-z0-9]+\)/ and print "$1\n"'); do
  [[ ! -f $f ]] && continue
  mkdir -p /mnt/${f%/*} && cp -v $f /mnt/$f
done

e2fsck="$(which e2fsck)"
cp "$e2fsck" /mnt/sbin
for f in $(ldd "$e2fsck" | perl -ne '/(\S+) \(0x[a-z0-9]+\)/ and print "$1\n"'); do
  [[ ! -f $f ]] && continue
  mkdir -p /mnt/${f%/*} && cp -v $f /mnt/$f
done

umount="$(which umount)"
cp "$umount" /mnt/sbin
for f in $(ldd "$umount" | perl -ne '/(\S+) \(0x[a-z0-9]+\)/ and print "$1\n"'); do
  [[ ! -f $f ]] && continue
  mkdir -p /mnt/${f%/*} && cp -v $f /mnt/$f
done

#cat > /mnt/init <<'EOF'
##!/bin/bash
#
#run_from_file() {
#  local f t
#  for f in /dev/fd/*; do
#    [ -h $f ] || continue
#    [ $f -ef "$0" ] && return
#  done
#  t=$(mktemp)
#  cat > $t
#  if [ "$(head -n 1 $t)" = '#!/bin/bash' ]; then
#    chmod +x $t
#    exec /bin/bash $t "$@" </dev/fd/2
#  else
#    rm -f $t
#    echo "Direct execution not supported with this shell ($_)." >&2
#    echo "Please try bash instead." >&2
#    exit 1
#  fi
#}
#
## do not modify the two lines below
#[ -h /dev/fd/0 ] && run_from_file
##!/bin/bash
#echo "=== starting init ==="
#set -x
#/bin/bash -l -i
#set +x
#echo "=== end of init. rebooting in 5s ==="
#sleep 5
#reboot -f
#EOF

#cat > /mnt/init <<'EOF'
##!/bin/bash
#echo "=== starting init ==="
#set -x
#/bin/bash -l -i
#set +x
#echo "=== end of init. rebooting in 5s ==="
#sleep 5
#reboot -f
#EOF

root="$(findmnt / --first-only --noheadings -o SOURCE)"
root_dev="$(echo "$root" | sed 's/[0-9]\+$//')"

cat > /mnt/init <<EOF
#!/bin/sh

set -e

root="$root"
root_dev="$root_dev"
RECOVERY="$RECOVERY"
REBOOT="$REBOOT"

EOF

cat >> /mnt/init <<'EOF'

on_exit() {
   rc="$?"
   if [ "$rc" -eq 0 ]; then
     echo "=== init done: rebooting in 5s ==="
     for i in $(seq 1 5); do
        sleep 1
        echo -n '.'
     done
     sync
     [ -n "$REBOOT" ] && reboot -f
   else
     echo "=== init failed: opening shell ==="
     sync
     [ -n "$RECOVERY" ] && /bin/sh
   fi
}

trap on_exit EXIT

echo "=== unmounting old root ==="
umount -l "$root"
timeout 5s sh -c "until mount '$root' /old; do sleep 1; done"
timeout 5s sh -c "until umount '$root'; do sleep 1; done"

echo "=== starting init ==="

echo "=== converting to btrfs ==="
/sbin/btrfs-convert -L "$root"

echo "=== mounting btrfs root ==="
mount "$root" /old

echo "=== removing ext4 snapshot ==="
btrfs subvolume delete /old/ext2_saved

echo "=== defragging ==="
btrfs filesystem defrag -r /old

echo "=== rebalancing ==="
btrfs balance start /old

echo "=== updating fstab ==="
sed -i -e 's/\(LABEL=DOROOT.*\)ext4/\1btrfs/' /old/etc/fstab
sed -i -e 's/errors=remount-ro/defaults/' /old/etc/fstab

echo "=== reinstalling grub ==="
mount -t proc proc /old/proc
mount -t sysfs sys /old/sys
mount -o bind /dev /old/dev
chroot /old grub-mkconfig -o /boot/grub/grub.cfg
chroot /old grub-install "$root_dev"

echo "=== rebuilding initramfs ==="
for pkg in $(chroot /old /usr/bin/dpkg -l 'linux-image-*-*' | grep ^ii | awk '{print $2}'); do
    chroot /old /usr/sbin/dpkg-reconfigure $pkg
done

echo "=== unmounting root ==="
umount /old/dev
umount /old/sys
umount /old/proc
umount /old
sync

EOF

chmod 0755 /mnt/init

losetup -D || true
modprobe btrfs

sleep 1
trap - EXIT

mount --types proc /proc /mnt/proc
mount --rbind /sys /mnt/sys
mount --make-rslave /mnt/sys
mount --rbind /dev /mnt/dev
mount --make-rslave /mnt/dev
mount --bind /run /mnt/run
mount --make-slave /mnt/run

# pivot_root won't work with MS_SHARED
mount --make-private /
mount --make-private /mnt

cd /mnt
pivot_root . old
exec chroot . /init
